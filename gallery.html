<!DOCTYPE html>
<html lang="en" class="bg-slate-950 text-white">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event Gallery (Admin)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .media-card {
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .media-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.55);
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="relative isolate overflow-hidden min-h-screen">
    <div class="absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(129,140,248,0.25),_transparent_60%)]"></div>

    <!-- HEADER -->
    <header class="max-w-6xl mx-auto px-6 py-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <p class="text-xs uppercase tracking-wide text-slate-400">Event admin</p>
        <h1 class="text-3xl font-semibold">Event gallery</h1>
        <p id="info" class="mt-2 text-sm text-slate-300"></p>
      </div>

      <div class="flex gap-3">
        <button id="refreshBtn"
          class="rounded-xl bg-white/10 px-4 py-2 text-sm font-semibold hover:bg-white/20 transition">
          Refresh
        </button>
        <button id="logoutBtn"
          class="rounded-xl bg-rose-600 px-4 py-2 text-sm font-semibold hover:bg-rose-500 transition">
          Logout
        </button>
      </div>
    </header>

    <!-- MAIN -->
    <main class="max-w-6xl mx-auto px-6 pb-16">
      <div id="grid"
           class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      </div>
    </main>
  </div>

  <!-- PREVIEW MODAL -->
  <div id="modal"
       class="fixed inset-0 hidden items-center justify-center bg-black/70 p-4">
    <div class="w-full max-w-5xl rounded-2xl bg-slate-900 border border-white/10 p-4">
      <div class="flex items-center justify-between mb-3">
        <p class="text-sm text-slate-300">Preview</p>
        <button id="closeModal"
          class="text-sm text-slate-300 hover:text-white">
          Close
        </button>
      </div>

      <img id="modalImg"
           class="hidden max-h-[75vh] w-full rounded-lg object-contain"
           alt="Preview image" />

      <video id="modalVideo"
             class="hidden max-h-[75vh] w-full rounded-lg"
             controls></video>
    </div>
  </div>

<script>
const API_BASE = "https://event-upload-api.surendra-david-puppala.workers.dev";
const params = new URLSearchParams(location.search);
const eventId = params.get("eventId");

const grid = document.getElementById("grid");
const info = document.getElementById("info");

if (!eventId) {
  location.href = "/event-admin-login.html";
}

info.textContent = `Loading uploads for event ${eventId}â€¦`;

document.getElementById("refreshBtn").addEventListener("click", loadFiles);
document.getElementById("logoutBtn").addEventListener("click", logout);
document.getElementById("closeModal").addEventListener("click", closeModal);
document.getElementById("modal").addEventListener("click", (e) => {
  if (e.target.id === "modal") closeModal();
});

async function loadFiles() {
  grid.innerHTML = loadingCard("Loading uploadsâ€¦");

  try {
    const res = await fetch(`${API_BASE}/api/event-admin/list-files`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include", // ðŸ” OAuth cookie
      body: JSON.stringify({ eventId })
    });

    if (res.status === 401) {
      location.href = `/event-admin-login.html?eventId=${encodeURIComponent(eventId)}`;
      return;
    }

    const data = await res.json();

    if (!res.ok) {
      grid.innerHTML = errorCard(data.error || "Failed to load uploads.");
      return;
    }

    const files = Array.isArray(data.files) ? data.files : [];

    if (files.length === 0) {
      info.textContent = "No uploads yet for this event.";
      grid.innerHTML = emptyCard();
      return;
    }

    info.textContent = `Showing ${files.length} upload(s).`;
    grid.innerHTML = "";

    for (const file of files) {
      grid.appendChild(buildMediaCard(file));
    }
  } catch (err) {
    console.error(err);
    grid.innerHTML = errorCard("Network error. Please try again.");
  }
}

function buildMediaCard(file) {
  const card = document.createElement("div");
  card.className =
    "media-card rounded-2xl overflow-hidden bg-white/5 border border-white/10";

  const isVideo = file.name.toLowerCase().endsWith(".mp4");
  const url =
    `${API_BASE}/media?eventId=${encodeURIComponent(eventId)}&file=${encodeURIComponent(file.name)}`;

  const preview = document.createElement(isVideo ? "video" : "img");
  preview.src = url;
  preview.className = "h-44 w-full object-cover bg-black";
  if (isVideo) preview.muted = true;

  const meta = document.createElement("div");
  meta.className = "p-3";

  const type = document.createElement("p");
  type.className = "text-xs uppercase tracking-wide text-slate-400";
  type.textContent = isVideo ? "Video" : "Photo";

  const name = document.createElement("p");
  name.className = "mt-1 text-sm font-medium truncate";
  name.textContent = file.name;

  meta.appendChild(type);
  meta.appendChild(name);

  card.appendChild(preview);
  card.appendChild(meta);
  card.addEventListener("click", () => openModal(url, isVideo));

  return card;
}

function openModal(src, isVideo) {
  const modal = document.getElementById("modal");
  const img = document.getElementById("modalImg");
  const video = document.getElementById("modalVideo");

  img.classList.add("hidden");
  video.classList.add("hidden");
  video.pause();

  if (isVideo) {
    video.src = src;
    video.classList.remove("hidden");
  } else {
    img.src = src;
    img.classList.remove("hidden");
  }

  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

function closeModal() {
  document.getElementById("modal").classList.add("hidden");
  document.getElementById("modalVideo").pause();
}

async function logout() {
  await fetch(`${API_BASE}/api/event-admin/logout`, {
    method: "POST",
    credentials: "include"
  });

  location.href = `/event-admin-login.html?eventId=${encodeURIComponent(eventId)}`;
}

function loadingCard(text) {
  return `
    <div class="col-span-full rounded-2xl bg-white/5 border border-white/10 p-6 text-sm text-slate-300">
      ${text}
    </div>
  `;
}

function emptyCard() {
  return `
    <div class="col-span-full rounded-2xl bg-white/5 border border-white/10 p-6 text-sm text-slate-300">
      No uploads yet. Check back after guests start uploading.
    </div>
  `;
}

function errorCard(text) {
  return `
    <div class="col-span-full rounded-2xl bg-white/5 border border-rose-500/30 p-6 text-sm text-rose-400">
      ${text}
    </div>
  `;
}

loadFiles();
</script>

</body>
</html>
