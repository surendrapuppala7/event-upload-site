<!DOCTYPE html>
<html lang="en" class="dark:bg-black dark:text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Event Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .glass {
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: rgba(255, 255, 255, 0.15);
    }
    .dark .glass {
      background: rgba(20, 20, 20, 0.4);
    }
  </style>
</head>

<body class="min-h-screen p-6">

  <h1 class="text-3xl font-bold mb-6 text-center">üìÅ Event Admin Dashboard</h1>

  <div class="max-w-4xl mx-auto glass p-6 rounded-2xl shadow-xl border border-white/20">

    <div class="flex justify-between items-center mb-4">
      <h2 id="eventLabel" class="text-xl font-bold"></h2>
      <button onclick="logout()" class="text-sm text-red-400 hover:text-red-500">
        Log out
      </button>
    </div>

    <p class="text-gray-500 dark:text-gray-300 mb-6">
      View and download all media uploaded to this event.
    </p>

    <button onclick="downloadAll()"
      class="mb-6 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-xl shadow">
      ‚¨áÔ∏è Download All Files (one by one)
    </button>

    <!-- File List -->
    <h3 class="text-lg font-semibold mb-2">Files</h3>

    <div id="fileList" class="space-y-2 mb-4"></div>

    <p id="status" class="text-center text-red-500 mt-4"></p>

  </div>

<script>
const API_BASE = "https://event-upload-api.surendra-david-puppala.workers.dev";

const eventId = sessionStorage.getItem("eventId");
const email = sessionStorage.getItem("email");
const password = sessionStorage.getItem("password");

if (!eventId || !email || !password) {
  window.location.href = "event-admin-login.html";
}

document.getElementById("eventLabel").textContent = "Event: " + eventId;

let currentFiles = [];

function logout() {
  sessionStorage.removeItem("eventId");
  sessionStorage.removeItem("email");
  sessionStorage.removeItem("password");
  window.location.href = "event-admin-login.html";
}

async function loadFiles() {
  const status = document.getElementById("status");
  status.textContent = "Loading files...";

  const res = await fetch(`${API_BASE}/api/event-admin/list-files`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ eventId, email, password })
  });

  const data = await res.json().catch(() => ({}));
  const list = document.getElementById("fileList");
  list.innerHTML = "";
  currentFiles = [];

  if (!res.ok) {
    status.textContent = data.error || "Error loading files.";
    return;
  }

  status.textContent = "";

  currentFiles = data.files || [];

  if (!currentFiles.length) {
    list.innerHTML = `<p class="text-gray-500">No files uploaded yet.</p>`;
    return;
  }

  currentFiles.forEach(file => {
    const row = document.createElement("div");
    row.className = "flex justify-between items-center bg-white/10 dark:bg-black/30 p-3 rounded-lg";

    const sizeKB = (file.size / 1024).toFixed(1);
    const uploaded = file.uploaded ? new Date(file.uploaded).toLocaleString() : "";

    row.innerHTML = `
      <div>
        <div class="font-semibold break-all">${file.name}</div>
        <div class="text-xs text-gray-400">${sizeKB} KB ‚Ä¢ ${uploaded}</div>
      </div>
      <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm"
        onclick="downloadFile('${file.name}')">
        Download
      </button>
    `;

    list.appendChild(row);
  });
}

async function downloadFile(fileName) {
  const res = await fetch(`${API_BASE}/api/event-admin/get-file`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ eventId, email, password, fileName })
  });

  if (!res.ok) {
    alert("Download failed.");
    return;
  }

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  a.click();

  URL.revokeObjectURL(url);
}

async function downloadAll() {
  if (!currentFiles.length) {
    alert("No files to download.");
    return;
  }
  for (const file of currentFiles) {
    await downloadFile(file.name);
  }
}

loadFiles();
</script>

</body>
</html>
